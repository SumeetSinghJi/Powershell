Common Powershell Scripts

KB Article # 1584

Policy


Procedure

# Setup Profile


New-Item -path $profile -type file –force
$Profile
notepad.exe (file path above in $profile command output)

# Exchange connection string (run each step independently)


1) Set-ExecutionPolicy Unrestricted

2) $Credentials = Get-Credential
$Session = New-PSSession -ConfigurationName Microsoft.Exchange -ConnectionUri https://outlook.office365.com/powershell-liveid/ -Credential $Credentials -Authentication Basic –AllowRedirection

3) Import-PSSession $Session


Also add permissions
EAC - Permissions

Discovery Management
Import Export



# Run Azure remotely

$session = new-PSSession -computerName ADFSADC01

Invoke-Command -scriptblock { Import-Module ADSync } -session $session

Invoke-Command -scriptblock { Start-ADSyncSyncCycle -PolicyType Delta } -session $session

Invoke-Command -scriptblock { Get-ADSyncConnectorRunStatus } -session $session

#Find cmdlet's module

(Get-Command -Name Get-Mailbox).ModuleName



#Mailbox permission check and add

get-mailboxpermission -Identity "valet@cos.net.au"

add-mailboxpermission -Identity "valet@cos.net.au" -User "admin" -AccessRights FullAccess 

Add-MailboxPermission -Identity @cos.net.au -User manager@cos.net.au -AccessRights FullAccess -AutoMapping:$false 

# Set mailbox type 

Set-Mailbox MarketingDept1 -Type Shared

Set-Mailbox <name> -Type:<regular|shared|equipment|room>

Set-Mailbox MarketingDept1 -Type Shared -automapping:$false


#Calendar Permission
add-MailboxFolderPermission -Identity lilianmi@cos.net.au:\calendar -User hollyn@cos.net.au -AccessRights editor

#If above is already added and you wish to modify calendar permission
set-MailboxFolderPermission -Identity lilianmi@cos.net.au:\calendar -User hollyn@cos.net.au -AccessRights editor

#To see current permissions
get-MailboxFolderPermission -Identity lilianmi@cos.net.au:\calendar

# Mailbox Permissions


Get-Mailbox | Get-MailboxPermission -User belindaw@cos.net.au


#Add 1 user to all room calendars

Get-Mailbox -Resultsize unlimited -RecipientTypeDetails RoomMailbox | % {Add-MailboxFolderPermission "$($_.Alias):\Calendar" -User hollyn@cos.net.au -AccessRights Editor}


# Get Mailbox total size in GB

Get-Mailbox melitam@cos.net.au | Get-MailboxStatistics |
Add-Member -MemberType ScriptProperty -Name TotalItemSizeinMB -Value {$this.totalitemsize.value.ToMB()} -PassThru |
Format-Table DisplayName,TotalItem*

#Exchange Mail Trace Rule ID find 

get-transportrule | select -Property * | select name, guid



#To copy groups to another existing user use:

get-aduser -identity johns -properties memberof | select-object memberof -expandproperty memberof | Add-AdGroupMember -Members stevej
#in example above, stevej will be added to johns's groups.



# Get AD group members, names and emails

Get-ADGroupMember -Identity "groupname" -Recursive | 
Get-ADUser -Properties Mail | 
Select-Object Name,Mail | 
Export-CSV -Path C:\file.csv -NoTypeInformation
 

# Get Adusers by Site OU

$adelaide = Get-ADUser -Filter * -SearchBase “OU=Users,OU=Adelaide,OU=Sites,OU=Complete Office Supplies,DC=cos2000,DC=cos,DC=net,DC=au” | select name

$brisbanne = Get-ADUser -Filter * -SearchBase “OU=Users,OU=Brisbane,OU=Sites,OU=Complete Office Supplies,DC=cos2000,DC=cos,DC=net,DC=au” | select name

$canberra = Get-ADUser -Filter * -SearchBase “OU=Users,OU=Canberra,OU=Sites,OU=Complete Office Supplies,DC=cos2000,DC=cos,DC=net,DC=au” | select name

$darwin = Get-ADUser -Filter * -SearchBase “OU=Users,OU=Darwin,OU=Sites,OU=Complete Office Supplies,DC=cos2000,DC=cos,DC=net,DC=au” | select name

$hobart = Get-ADUser -Filter * -SearchBase “OU=Users,OU=Hobart,OU=Sites,OU=Complete Office Supplies,DC=cos2000,DC=cos,DC=net,DC=au” | select name

$lidcombe = Get-ADUser -Filter * -SearchBase “OU=Users,OU=Lidcombe,OU=Sites,OU=Complete Office Supplies,DC=cos2000,DC=cos,DC=net,DC=au” | select name

$melbourne = Get-ADUser -Filter * -SearchBase “OU=Users,OU=Melbourne,OU=Sites,OU=Complete Office Supplies,DC=cos2000,DC=cos,DC=net,DC=au” | select name

$newcastle = Get-ADUser -Filter * -SearchBase “OU=Users,OU=Newcastle,OU=Sites,OU=Complete Office Supplies,DC=cos2000,DC=cos,DC=net,DC=au” | select name

$perth = Get-ADUser -Filter * -SearchBase “OU=Users,OU=Perth,OU=Sites,OU=Complete Office Supplies,DC=cos2000,DC=cos,DC=net,DC=au” | select name



#send test email from Ds01

From field should only be internal COS domain address
Send-MailMessage -SmtpServer "smtp.cos.net.au" -From "cosnet_integration@cos.net.au" -To "customerservice@cos.net.au" -Bcc "waqasm@cos.net.au" -Subject "Test email COSNET PO Integration Failed" -Body "This is a test email" -Attachments ("C:\test.pdf")

# Search Hidden Item
Get-ChildItem 'c:\users\public\desktop' -recurse -force

#Remove hidden item

Remove-Item -path 'c:\users\public\desktop\Google Chrome.lnk' -Force




# Find folder permissions

$OutFile = "C:\temp\Permissions.csv"
$Header = "Folder Path,IdentityReference,AccessControlType,IsInherited,InheritanceFlags,PropagationFlags"
Add-Content -Value $Header -Path $OutFile 

$RootPath = "\\fs03\Admin"

$Folders = dir $RootPath -recurse | where {$_.psiscontainer -eq $true}

foreach ($Folder in $Folders){
$ACLs = get-acl $Folder.fullname | ForEach-Object { $_.Access  }
Foreach ($ACL in $ACLs){
$OutInfo = $Folder.Fullname + "," + $ACL.IdentityReference  + "," + $ACL.AccessControlType + "," + $ACL.IsInherited + "," + $ACL.InheritanceFlags + "," + $ACL.PropagationFlags
Add-Content -Value $OutInfo -Path $OutFile
}}

# Remote Mobi Powershell script, Enter your script inside the curly brackets, below is getting the Office Activation key
start C:\Windows\System32\WindowsPowerShell\v1.0\Powershell.exe -NoProfile -NonInteractive -Command "& {wmic path SoftwareLicensingService get OA3xOriginalProductKey > C:\test.txt}"
# Find New users that have started within the last 30 days
$When = ((Get-Date).AddDays(-30)).Date
Get-ADUser -Filter {whenCreated -ge $When} -Properties whenCreated | select name



# Get all Room calendards


Get-MailBox | where {$_.ResourceType -eq "Room"} | select name | ft -autosize

# Set Room calendar booking days

Set-CalendarProcessing roomname-BookingWindowsInDays 365



# Get all Room permissions

$ConPermission = @() 
 
$rooms = get-mailbox -RecipientTypeDetails roommailbox -resultsize unlimited 
 
Foreach ($Mailbox in $rooms) 
{ 
 
$perm = Get-mailboxfolderpermission -identity ($Mailbox.alias+':\calendar') 
$userN = $null 
$userC = $null 
$userA = $null 
$userPA = $null 
$userNEA = $null 
$userR =  $null 
$userE = $null 
$userPE = $null 
$userO = $null 
$userAO = $null 
$userL = $null 
 
   foreach ($acc in $perm){ 
       $user = $null 
       $user = $acc.user 
       $user = $user.ToString() 
       $access =  $acc.accessrights 
    Switch($access){  
        None { $userN += $user + ","} 
    Contributor { $userC += $user + ","} 
    author { $userA += $user + ","} 
    PublishingAuthor { $userPA += $user + ","} 
    NonEditingAuthor { $userNEA += $user + ","} 
    Reviewer { $userR += $user + ","} 
    Editor { $userE += $user + ","} 
    PublishingEditor { $userPE += $user + ","} 
    Owner { $userO += $user + ","} 
    Availabilityonly { $userAO += $user + ","} 
    Limiteddetails { $userL += $user + ","} 
    default {"Something else happened"} 
        } 
    } 
 
$roomp = "" | select ConfRoomname,None,Contributor,author,PublishingAuthor,NonEditingAuthor,Reviewer,Editor,PublishingEditor,Owner,Availabilityonly,Limiteddetails 
$roomp.ConfRoomname = $Mailbox.displayname 
$roomp.None = $userN 
$roomp.Contributor = $userC 
$roomp.author = $userA 
$roomp.PublishingAuthor = $userPA 
$roomp.NonEditingAuthor = $userNEA 
$roomp.Reviewer = $userR 
$roomp.Editor = $userE 
$roomp.PublishingEditor = $userPE 
$roomp.Owner = $userO 
$roomp.Availabilityonly = $userAO 
$roomp.Limiteddetails = $userL 
$ConPermission += $roomp 
} 
 
$ConPermission | export-csv .\ConfPermissions.csv -notypeinformation



Author: Summer Chand
Dated: 15/06/2017
Reviewer:
Review Date:
